version: '3.8'

services:
  # 1. SERVI√áO DE TUNELAMENTO SSH DEDICADO (Mantido, assumindo que √© necess√°rio para outro servi√ßo)
  ssh_tunnel:
    build:
      context: .
      dockerfile: dockerfile.ssh
    container_name: ssh_tunnel_planka
    restart: unless-stopped
    # logging:
    #   driver: "none"

  planka:
    container_name: planka
    image: ghcr.io/plankanban/planka:2.0.0-rc.4
    restart: on-failure

    volumes:
      - favicons:/app/public/favicons
      - user-avatars:/app/public/user-avatars
      - background-images:/app/public/background-images
      - attachments:/app/private/attachments

    ports:
      - 7002:1337

    environment:
      - BASE_URL=http://ipelabor.sytes.net:7002

      # üöÄ MUDAN√áA CR√çTICA: DATABASE_URL APONTANDO PARA O SERVIDOR EXTERNO
      # Formato: postgresql://user:password@host:port/database
      # Usando 'root', 'q1w2e3', 'ipelabor.sytes.net', porta '7432' e 'planka' (BD padr√£o)
      - DATABASE_URL=postgresql://root:q1w2e3@ipelabor.sytes.net:7432/planka

      - SECRET_KEY=8A5kLzTq9oPj1fGyC4hR2sXbN7vM3uW6eD0iFaE5gB9cJxK7lY8mZ4pV6rS3tQ2wU1

      # üìù Configura√ß√£o de administrador padr√£o do Planka (Recomendado para primeiro acesso)
      - DEFAULT_ADMIN_EMAIL=gustavo.souza@ipelabor.com.br
      - DEFAULT_ADMIN_PASSWORD=MagicKir137!
      - DEFAULT_ADMIN_NAME=Gustavo Souza
      - DEFAULT_ADMIN_USERNAME=twentyone
      # Outras configura√ß√µes opcionais
      # - LOG_LEVEL=warn

      # Email Notifications (https://nodemailer.com/smtp/)
      # These values override and disable configuration in the UI if set.
      - SMTP_HOST=mail.ipelabor.com.br
      - SMTP_PORT=465
      - SMTP_NAME=Gustavo Souza
      - SMTP_SECURE=true
      - SMTP_TLS_REJECT_UNAUTHORIZED=false
      - SMTP_USER=gustavo.souza@ipelabor.com.br
      - SMTP_PASSWORD=MagicKir137!
      # Optionally store in secrets - then SMTP_PASSWORD should not be set
      # - SMTP_PASSWORD__FILE=/run/secrets/smtp_password
      - SMTP_FROM="Gustavo Souza" <gustavo.souza@ipelabor.com.br>

    depends_on:
      ssh_tunnel:
        condition: service_started
      # üí• DEPEND√äNCIA DO POSTGRES LOCAL REMOVIDA

      # Defini√ß√£o dos volumes para persist√™ncia de arquivos do Planka
volumes:
  favicons:
  user-avatars:
  background-images:
  attachments: # üí• VOLUME 'db-data' REMOVIDO
